<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VG Cargo Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef;
      margin: 0;
      padding: 20px;
      display: flex;
      gap: 20px;
    }
    .main {
      flex: 2;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    .calendar {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #007BFF;
      color: white;
    }
    .summary {
      margin-top: 10px;
      text-align: right;
      font-weight: bold;
    }
    .calendar-nav {
      margin-bottom: 10px;
    }
    .calendar-table {
      margin-bottom: 20px;
    }
    td.marked {
      background: #ffc107;
      font-weight: bold;
      cursor: help;
      position: relative;
    }
    td.marked.apron::after {
      content: '✈️';
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 14px;
    }
    .info {
      margin: 10px 0;
      font-size: 14px;
      color: #007BFF;
    }
    .time-display {
  font-size: 18px;
  font-weight: bold;
  color: #333;
  margin-bottom: 10px;
  text-align: center;
}
    button.delete-btn {
      padding: 6px 14px;
      font-size: 14px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.delete-btn:hover {
      background-color: #a71d2a;
    }
    button.ref-link {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    button.calendar-btn {
  padding: 6px 14px;
  font-size: 14px;
  background-color: #17a2b8;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
}
    button.ref-link:hover {
      background-color: #117a8b;
    }
    input[type="text"],
input[type="email"],
input[type="number"],
textarea {
  padding: 10px;
  margin-bottom: 12px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 14px;
  box-sizing: border-box;
}

textarea {
  min-height: 80px;
  resize: vertical;
  font-family: Arial, sans-serif;
  line-height: 1.4;
}
    .filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}
.filter-row label {
  font-weight: bold;
  margin-right: 5px;
}
.filter-row input[type="text"],
.filter-row input[type="date"] {
  width: 180px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
  </style>
</head>
<body>
  <div class="main">
    <h2>Charter Dashboard</h2>
    <div class="time-display">
      <span id="currentDate">Date: --</span> | <span id="clock">Time: --:--:--</span>
    </div>
<div class="filter-row">
  <label>Reference:</label> <input type="text" id="refSearch" onkeyup="filterTable()" />
  <label>Airline:</label> <input type="text" id="airlineSearch" onkeyup="filterTable()" />
  <label>Flugnummer:</label> <input type="text" id="flightNumberSearch" onkeyup="filterTable()" />
  </div>
<div class="filter-row">
  <label>Von:</label> <input type="date" id="startDate" onchange="filterTable()" />
  <label>Bis:</label> <input type="date" id="endDate" onchange="filterTable()" />
  <label><input type="checkbox" id="showArchive" onchange="filterTable()" /> Archiv zeigen</label>
</div>
    <div class="summary" id="summaryInfo">Total Flights: 0 | Total Tonnage: 0 kg</div>
    <table>
      <thead>
        <tr><th>Reference</th><th>Flight No.</th><th>Date</th><th>Airline</th><th>Tonnage (kg)</th><th>Actions</th></tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>
    <div id="detailModal" style="display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
     background:white; border-radius:10px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:1000; width:600px; max-height:90vh; overflow-y:auto; font-family:Arial, sans-serif;">
      <h2 style="margin-top:0; color:#007bff;">Flugdetails & Bearbeitung</h2>
      <div style="margin-bottom:20px;">
        <h4 style="margin-bottom:5px; border-bottom:1px solid #ccc;">Kundendaten (Original)</h4>
        <p><strong>Ref:</strong> <span id="viewRef"></span></p>
        <p><strong>Airline:</strong> <span id="viewAirline"></span></p>
        <p><strong>Datum:</strong> <span id="viewDate"></span></p>
        <p><strong>Tonnage:</strong> <span id="viewTonnage"></span></p>
        <p><strong>Billing Company:</strong> <span id="viewBillingCompany"></span></p>
        <p><strong>Billing Address:</strong> <span id="viewBillingAddress"></span></p>
        <p><strong>Tax Number:</strong> <span id="viewTaxNumber"></span></p>
        <p><strong>Contact Name:</strong> <span id="viewContactName"></span></p>
        <p><strong>Contact Email:</strong> <span id="viewContactEmail"></span></p>
        <p><strong>Original Mail:</strong></p>
<div style="background:#f8f8f8; padding:10px; border-radius:5px; max-height:300px; overflow:auto; white-space:pre-wrap; font-family:monospace;">
  <pre id="viewEmailRequest" style="background:#f9f9f9;padding:10px;border-radius:5px;white-space:pre-wrap;word-break:break-word;margin:0;"></pre>
</div>
        <p><strong>AGB akzeptiert:</strong> ✅</p>
        <p><strong>Leistungsverzeichnis gelesen:</strong> ✅</p>
      </div>
      <div>
        <h4 style="margin-bottom:5px; border-bottom:1px solid #ccc;">Interne Bearbeitung</h4>
        <form id="detailForm">
          <input type="hidden" id="modalRef" />
          <label>Kunde (Name):</label>
          <input type="text" id="customerName" />
          <label>Flugnummer:</label>
          <input type="text" id="flightNumberInput" style="width:100%" placeholder="z.B. LH123" /><br>
          <label>Flugzeit:</label>
          <input type="text" id="flightTime" placeholder="z.B. 14:45" />
          <label>Manifestgewicht (kg):</label>
          <input type="number" id="manifestWeight" step="0.001" />
          <label>Rate (€):</label>
          <input type="number" id="rate" step="0.001" />
          <label>Weitere Preise:</label>
          <textarea id="otherPrices" placeholder="z.B. Handling: 500 €&#10;Screening: 300 €"></textarea>
          <label><input type="checkbox" id="apronSupport" /> Vorfeldbegleitung gewünscht</label><br><br>
          <div style="text-align:right;">
            <button type="button" onclick="saveDetails()" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:5px;">Speichern</button>
            <button type="button" onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:5px;">Schließen</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="calendar">
    <div class="calendar-nav">
      <button class="calendar-btn" onclick="shiftCalendar(-1)">← Back</button>
      <button class="calendar-btn" onclick="shiftCalendar(1)">Forward →</button>
    </div>
    <div id="calendarArea"></div>
  </div>
  <script>
let requestData = [];

function populateRows() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  requestData.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><button class="ref-link" onclick="openDetails('${r.ref}')">${r.ref}</button></td>
  <td>${r.flightNumber || "-"}</td>
  <td>${r.date.toLocaleDateString('de-DE')}</td>
  <td>${r.airline}</td>
  <td>${r.tonnage.toLocaleString('de-DE')}</td>
  <td><button class="delete-btn" onclick="deleteRequest('${r.ref}')">Delete</button></td>`;
    table.appendChild(row);
  });
  filterTable();
  renderCalendars();
}

function filterTable() {
  const refVal = document.getElementById("refSearch").value.toLowerCase();
  const airlineVal = document.getElementById("airlineSearch").value.toLowerCase();
  const flightVal = document.getElementById("flightSearch")?.value?.toLowerCase() || "";

  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);
  const showArchive = document.getElementById("showArchive").checked;

  const rows = document.querySelectorAll("#dataTable tr");
  let totalFlights = 0;
  let totalTonnage = 0;

  rows.forEach(row => {
    const cells = row.children;
    const ref = cells[0].textContent.toLowerCase();
    const flight = cells[1].textContent.toLowerCase();
    const date = new Date(cells[2].textContent.split('.').reverse().join('-'));
    const airline = cells[3].textContent.toLowerCase();
    const tonnage = parseFloat(cells[4].textContent.replace(/\./g, '').replace(/,/g, '.'));

    let show = true;

    if (refVal && !ref.includes(refVal)) show = false;
    if (airlineVal && !airline.includes(airlineVal)) show = false;
    if (flightVal && !flight.includes(flightVal)) show = false;

    if (!isNaN(startDate.getTime()) && date < startDate) show = false;
    if (!isNaN(endDate.getTime()) && date > endDate) show = false;

    if (!showArchive && date < new Date().setHours(0,0,0,0)) show = false;

    row.style.display = show ? "" : "none";
    if (show) {
      totalFlights++;
      totalTonnage += tonnage;
    }
  });

  document.getElementById("summaryInfo").textContent =
    `Total Flights: ${totalFlights} | Total Tonnage: ${totalTonnage.toLocaleString('de-DE')} kg`;
}

function deleteRequest(ref) {
  if (confirm("Are you sure you want to delete this request?")) {
    // 1. Lokal entfernen
    const index = requestData.findIndex(r => r.ref === ref);
    if (index !== -1) requestData.splice(index, 1);
    populateRows();

    // 2. Anfrage ans Google Apps Script zum Löschen im Sheet
    const url = "https://script.google.com/macros/s/AKfycbyRaUcp6c0skDO_AKFbn6z2JVsdid1A-UWDRLYh_ayd3IJOUyz8bPhejpSbx4POwMuL/exec";
    const formData = new URLSearchParams();
    formData.append("mode", "delete");
    formData.append("ref", ref);

    fetch(url, {
      method: "POST",
      body: formData
    })
    .then(response => response.text())
    .then(result => {
      console.log("Löschergebnis:", result);
      alert("Anfrage wurde erfolgreich gelöscht!");
    })
    .catch(error => {
      console.error("Fehler beim Löschen:", error);
      alert("Fehler beim Löschen!");
    });
  }
}

function openDetails(ref) {
  const r = requestData.find(r => r.ref === ref);
  if (!r) return;
  document.getElementById("modalRef").value = r.ref;
  document.getElementById("viewRef").textContent = r.ref;
  document.getElementById("viewAirline").textContent = r.airline;
  document.getElementById("viewDate").textContent = r.date.toLocaleDateString('de-DE');
  document.getElementById("viewTonnage").textContent = `${r.tonnage.toLocaleString('de-DE')} kg (urspr.)${r.manifestWeight ? ` → ${r.manifestWeight.toLocaleString('de-DE')} kg (Manifest)` : ''}`;
  document.getElementById("viewBillingCompany").textContent = r.billingCompany || "-";
  document.getElementById("viewBillingAddress").textContent = r.billingAddress || "-";
  document.getElementById("viewTaxNumber").textContent = r.taxNumber || "-";
  document.getElementById("viewContactName").textContent = r.contactName || "-";
  document.getElementById("viewContactEmail").textContent = r.contactEmail || "-";
  document.getElementById("viewEmailRequest").textContent = r.emailRequest || "-";
  document.getElementById("customerName").value = r.customerName || "";
  document.getElementById("flightTime").value = r.flightTime || "";
  document.getElementById("manifestWeight").value = r.manifestWeight || "";
  document.getElementById("rate").value = r.rate || "";
  document.getElementById("otherPrices").value = r.otherPrices || "";
  document.getElementById("apronSupport").checked = r.apronSupport || false;
  document.getElementById("detailModal").style.display = "block";
}

function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

function saveDetails() {
  const ref = document.getElementById("modalRef").value;
  const r = requestData.find(r => r.ref === ref);
  if (!r) return;

  const finalWeight = parseFloat(document.getElementById("manifestWeight").value) || 0;
  const extraCharges = document.getElementById("otherPrices").value;
  const rate = parseFloat(document.getElementById("rate").value) || 0;
  const departureTime = document.getElementById("flightTime").value;
  const escort = document.getElementById("apronSupport").checked;
  const comment = document.getElementById("customerName").value;
  const flightNumber = document.getElementById("flightNumberInput").value;

  // Lokale Anzeige aktualisieren (optional)
  r.manifestWeight = finalWeight;
  r.otherPrices = extraCharges;
  r.rate = rate;
  r.flightTime = departureTime;
  r.apronSupport = escort;
  r.customerName = comment;
  r.flightNumber = flightNumber;

  // ❌ NICHT mehr: r.tonnage = r.manifestWeight;

  // In Google Sheet speichern
  saveExtrasToGoogleSheet(ref, finalWeight, extraCharges, rate, departureTime, escort, comment, flightNumber);

  closeModal();
  populateRows();
}

function updateClock() {
  const now = new Date();
  const options = {
    timeZone: 'Europe/Berlin',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  };
  const dateOptions = {
    timeZone: 'Europe/Berlin',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  };

  const time = new Intl.DateTimeFormat('de-DE', options).format(now);
  const dateParts = new Intl.DateTimeFormat('de-DE', dateOptions).format(now).split('.');
  const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

  document.getElementById("clock").textContent = "Time: " + time;
  document.getElementById("currentDate").textContent = "Date: " + formattedDate;
}

let calendarBase = new Date();
function shiftCalendar(offset) {
  calendarBase.setMonth(calendarBase.getMonth() + offset);
  renderCalendars();
}

function renderCalendars() {
  const container = document.getElementById("calendarArea");
  container.innerHTML = "";
  for (let i = 0; i < 2; i++) {
    const current = new Date(calendarBase.getFullYear(), calendarBase.getMonth() + i);
    container.innerHTML += generateCalendar(current.getFullYear(), current.getMonth());
  }
}

function generateCalendar(year, month) {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });

  let html = `<div class="calendar-table"><h4>${monthName} ${year}</h4><table><thead><tr><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th></tr></thead><tbody>`;
  let day = 1;
  let started = false;

  for (let i = 0; i < 6; i++) {
    html += "<tr>";
    for (let j = 1; j <= 7; j++) {
      const realDay = (j + 6) % 7;
      if (!started && realDay === firstDay) started = true;

      if (started && day <= daysInMonth) {
        const matches = requestData.filter(x => x.date.getDate() === day && x.date.getMonth() === month && x.date.getFullYear() === year);
        const hasEscort = matches.some(m => m.apronSupport);
const marked = matches.length ? "marked" : "";
const apron = hasEscort ? "apron" : "";
        const tooltip = matches.length
  ? matches.map(m =>
      `✈️ ${m.ref} – ${m.airline}
Flugnummer: ${m.flightNumber || '–'}
Abflugzeit: ${m.flightTime || '–'}
Tonnage: ${m.tonnage.toLocaleString('de-DE')} kg`
    ).join('\n')
  : "";
        const onclick = matches.length ? `onclick=\"openDetails('${matches[0].ref}')\"` : "";
        html += `<td class="${marked} ${apron}" title="${tooltip}" style="cursor:pointer;" ${onclick}>${day}</td>`;
        day++;
      } else {
        html += "<td></td>";
      }
    }
    html += "</tr>";
    if (day > daysInMonth) break;
  }
  html += "</tbody></table></div>";
  return html;
}

document.addEventListener('DOMContentLoaded', function () {
  const url = 'https://opensheet.elk.sh/1kCifgCFSK0lnmkqKelekldGwnMqFDFuYAFy2pepQvlo/CharterRequest';
  fetch(url)
    .then(response => response.json())
    .then(data => {
      requestData = data.map(row => ({
        ref: row["Ref"],
          flightNumber: row["Flugnummer"],
        date: new Date(row["Flight Date"]),
        airline: row["Airline"],
        billingCompany: row["Billing Company"],
        billingAddress: row["Billing Address"],
        taxNumber: row["Tax Number"],
        contactName: row["Contact Name"],
        contactEmail: row["Contact Email"],
        emailRequest: row["Email Request"],
        tonnage: parseFloat(row["Tonnage"]) || 0,
        apronSupport: row["Vorfeldbegleitung"] === "TRUE" // oder "Ja"
      }));
      populateRows();
    })
    .catch(error => console.error("Fehler beim Laden:", error));

  setInterval(updateClock, 1000);
  updateClock();
});

function saveExtrasToGoogleSheet(ref, finalWeight, extraCharges, rate, departureTime, escort, comment, flightNumber) {
  const url = "https://script.google.com/macros/s/AKfycbw2c2PSZlsKNGnQXFjhtpmezSSB_67D1BD3gt1jgVveY791Bb8inDIg4y0yb1Zhq_rm/exec";

  const formData = new URLSearchParams();
  formData.append("mode", "updateExtras");
  formData.append("ref", ref);
  formData.append("finalWeight", finalWeight);
  formData.append("extraCharges", extraCharges);
  formData.append("rate", rate);
  formData.append("departureTime", departureTime);
  formData.append("escort", escort ? "Ja" : "Nein");
  formData.append("comment", comment);
  formData.append("flightnumber", flightNumber);

  fetch(url, {
    method: "POST",
    body: formData
  })
    .then(response => response.text())
    .then(result => {
      console.log("Gespeichert:", result);
      alert("Änderungen gespeichert!");
    })
    .catch(error => {
      console.error("Fehler beim Speichern:", error);
      alert("Fehler beim Speichern!");
    });
}
// ESC zum Schließen des Detailmodals
document.addEventListener('keydown', function (e) {
  if (e.key === 'Escape') {
    closeModal();
  }
});

</script>
</body>
</html>
